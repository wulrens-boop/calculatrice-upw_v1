<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculatrice UPW</title>
<style>
:root {
  --bg-light: #f5f5f5;
  --bg-dark: #121212;
  --card-light: #ffffff;
  --card-dark: #1e1e1e;
  --text-light: #222;
  --text-dark: #e0e0e0;
  --border-light: #ddd;
  --border-dark: #333;
  --accent: #e74c3c;
  --accent-hover: #c0392b;
  --button-bg: #2c3e50;
  --button-hover: #34495e;
  --success: #27ae60;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-light);
  color: var(--text-light);
  padding: 20px;
  transition: background 0.3s ease;
}

body.dark-mode {
  background: var(--bg-dark);
  color: var(--text-dark);
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0;
  padding: 20px;
  background: var(--card-light);
  border-radius: 12px 12px 0 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

body.dark-mode .header {
  background: var(--card-dark);
}

.header h1 {
  font-size: 1.8em;
  font-weight: 600;
}

.switch {
  position: relative;
  width: 60px;
  height: 30px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  inset: 0;
  background: #ccc;
  border-radius: 30px;
  cursor: pointer;
  transition: 0.4s;
}

.slider::before {
  content: "‚òÄÔ∏è";
  position: absolute;
  height: 24px;
  width: 24px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: 0.4s;
}

input:checked + .slider {
  background: #4caf50;
}

input:checked + .slider::before {
  transform: translateX(30px);
  content: "üåô";
}

.cellules-banner {
  background: #0099cc;
  margin-bottom: 30px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 0 0 12px 12px;
  overflow: hidden;
}

.cellules-banner-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 25px;
  cursor: pointer;
  gap: 20px;
  transition: background 0.3s ease;
}

.cellules-banner-header:hover {
  background: rgba(0, 0, 0, 0.1);
}

.banner-title {
  color: white;
  font-weight: 600;
  font-size: 1em;
  white-space: nowrap;
}

.banner-values {
  display: flex;
  gap: 30px;
  flex: 1;
  justify-content: center;
  color: white;
  font-size: 0.95em;
}

.banner-values span {
  white-space: nowrap;
}

.banner-values strong {
  font-weight: 700;
  font-size: 1.1em;
}

.cellules-banner-header .arrow {
  color: white;
  font-size: 1.2em;
  transition: transform 0.3s ease;
}

.cellules-banner-header .arrow.active {
  transform: rotate(180deg);
}

.cellules-banner-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  background: rgba(0, 0, 0, 0.1);
}

.cellules-banner-content.active {
  max-height: 200px;
  padding: 20px 25px;
}

.cellules-banner-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.banner-input-group {
  display: flex;
  align-items: center;
  gap: 10px;
  color: white;
}

.banner-input-group label {
  font-weight: 600;
  white-space: nowrap;
}

.banner-input {
  width: 90px;
  padding: 8px 12px;
  font-size: 1em;
  font-weight: 600;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.9);
  color: #0099cc;
  text-align: center;
  transition: all 0.3s ease;
}

.banner-input:hover, .banner-input:focus {
  border-color: white;
  background: white;
  outline: none;
}

.banner-unit {
  font-weight: 600;
  color: white;
}

.card {
  background: var(--card-light);
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

body.dark-mode .card {
  background: var(--card-dark);
}

.card-title {
  font-size: 1.3em;
  font-weight: 600;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--accent);
}

.dropdown-container {
  position: relative;
  margin-bottom: 20px;
}

.dropdown {
  width: 100%;
  padding: 12px 40px 12px 15px;
  font-size: 1em;
  border: 2px solid var(--border-light);
  border-radius: 8px;
  background: var(--card-light);
  color: var(--text-light);
  cursor: pointer;
  appearance: none;
  transition: all 0.3s ease;
}

body.dark-mode .dropdown {
  background: var(--card-dark);
  color: var(--text-dark);
  border-color: var(--border-dark);
}

.dropdown:hover, .dropdown:focus {
  border-color: var(--accent);
  outline: none;
}

.dropdown-container::after {
  content: "‚ñº";
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--text-light);
}

body.dark-mode .dropdown-container::after {
  color: var(--text-dark);
}

.section {
  margin-bottom: 15px;
}

.section-header {
  background: var(--button-bg);
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  transition: background 0.3s ease;
}

.section-header:hover {
  background: var(--button-hover);
}

.section-header .arrow {
  transition: transform 0.3s ease;
}

.section-header.active .arrow {
  transform: rotate(180deg);
}

.section-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  background: var(--card-light);
  border-radius: 0 0 8px 8px;
}

body.dark-mode .section-content {
  background: var(--card-dark);
}

.section-content.active {
  max-height: 5000px;
  padding: 20px;
  border: 2px solid var(--border-light);
  border-top: none;
}

body.dark-mode .section-content.active {
  border-color: var(--border-dark);
}

.zone-header {
  background: var(--accent);
  color: white;
  padding: 12px 16px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  font-size: 0.95em;
  transition: all 0.3s ease;
}

.zone-header:hover {
  background: var(--accent-hover);
  transform: translateX(4px);
}

.zone-header .arrow {
  transition: transform 0.3s ease;
}

.zone-header.active .arrow {
  transform: rotate(180deg);
}

.zone-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.zone-content.active {
  max-height: 3000px;
  padding-top: 15px;
}

.param-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.param-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.param-label {
  font-weight: 600;
  font-size: 0.9em;
}

.param-value {
  padding: 10px;
  background: var(--bg-light);
  border: 2px solid var(--border-light);
  border-radius: 6px;
  text-align: center;
  font-weight: 600;
  color: var(--accent);
}

body.dark-mode .param-value {
  background: var(--bg-dark);
  border-color: var(--border-dark);
}

.borne-list {
  display: grid;
  gap: 10px;
}

.borne-item {
  display: grid;
  grid-template-columns: auto 1fr auto auto auto auto auto;
  gap: 15px;
  align-items: center;
  padding: 15px;
  background: var(--card-light);
  border: 2px solid var(--border-light);
  border-radius: 8px;
  transition: all 0.3s ease;
}

body.dark-mode .borne-item {
  background: var(--card-dark);
  border-color: var(--border-dark);
}

.borne-item:hover {
  border-color: var(--accent);
}

.borne-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.borne-name {
  font-weight: 600;
}

.borne-input {
  width: 80px;
  padding: 8px;
  border: 1px solid var(--border-light);
  border-radius: 4px;
  text-align: center;
  background: var(--bg-light);
  color: var(--text-light);
}

body.dark-mode .borne-input {
  background: var(--bg-dark);
  border-color: var(--border-dark);
  color: var(--text-dark);
}

.borne-energie, .borne-objectif {
  width: 120px;
  padding: 8px;
  border: 1px solid var(--border-light);
  border-radius: 4px;
  background: var(--bg-light);
  color: var(--text-light);
  cursor: pointer;
}

body.dark-mode .borne-energie, 
body.dark-mode .borne-objectif {
  background: var(--bg-dark);
  border-color: var(--border-dark);
  color: var(--text-dark);
}

.borne-result {
  font-weight: 600;
  color: var(--accent);
  min-width: 80px;
  text-align: right;
}

.borne-capacity {
  font-weight: 600;
  color: var(--success);
  min-width: 80px;
  text-align: center;
  padding: 8px 12px;
  background: var(--bg-light);
  border: 2px solid var(--success);
  border-radius: 6px;
}

body.dark-mode .borne-capacity {
  background: var(--bg-dark);
}

.borne-capacity.warning {
  color: #e67e22;
  border-color: #e67e22;
}

.borne-capacity.error {
  color: var(--accent);
  border-color: var(--accent);
}

.actions {
  display: flex;
  gap: 15px;
  margin-top: 20px;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  flex: 1;
}

.btn-primary {
  background: var(--success);
  color: white;
}

.btn-primary:hover {
  background: #229954;
  transform: translateY(-2px);
}

.btn-secondary {
  background: var(--button-bg);
  color: white;
}

.btn-secondary:hover {
  background: var(--button-hover);
  transform: translateY(-2px);
}

.btn-add {
  background: var(--success);
  color: white;
}

.btn-add:hover {
  background: #229954;
  transform: translateY(-2px);
}

.btn-delete {
  background: var(--accent);
  color: white;
}

.btn-delete:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
}

.gestion-section {
  margin-bottom: 30px;
}

.gestion-subtitle {
  font-size: 1.1em;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--text-light);
}

body.dark-mode .gestion-subtitle {
  color: var(--text-dark);
}

.gestion-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  align-items: end;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: 600;
  font-size: 0.9em;
  color: var(--text-light);
}

body.dark-mode .form-group label {
  color: var(--text-dark);
}

.form-select {
  padding: 10px;
  font-size: 1em;
  border: 2px solid var(--border-light);
  border-radius: 6px;
  background: var(--card-light);
  color: var(--text-light);
  cursor: pointer;
  transition: all 0.3s ease;
}

body.dark-mode .form-select {
  background: var(--card-dark);
  border-color: var(--border-dark);
  color: var(--text-dark);
}

.form-select:hover, .form-select:focus {
  border-color: var(--accent);
  outline: none;
}

.form-input {
  padding: 10px;
  font-size: 1em;
  border: 2px solid var(--border-light);
  border-radius: 6px;
  background: var(--card-light);
  color: var(--text-light);
  transition: all 0.3s ease;
}

body.dark-mode .form-input {
  background: var(--card-dark);
  border-color: var(--border-dark);
  color: var(--text-dark);
}

.form-input:hover, .form-input:focus {
  border-color: var(--accent);
  outline: none;
}

.separator {
  border: none;
  border-top: 2px solid var(--border-light);
  margin: 30px 0;
}

body.dark-mode .separator {
  border-top-color: var(--border-dark);
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üîã Calculatrice UPW</h1>
    <label class="switch">
      <input type="checkbox" id="themeToggle">
      <span class="slider"></span>
    </label>
  </div>

  <div class="cellules-banner">
    <div class="cellules-banner-header" onclick="toggleBanner()">
      <span class="banner-title">Valeur des cellules :</span>
      <div class="banner-values" id="bannerValuesPreview">
        <span>Fossile : <strong>7</strong> %</span>
        <span>Hydraulique : <strong>4.5</strong> %</span>
        <span>√âolienne : <strong>3</strong> %</span>
      </div>
      <span class="arrow" id="bannerArrow">‚ñº</span>
    </div>
    <div class="cellules-banner-content" id="bannerContent">
      <div class="cellules-banner-grid">
        <div class="banner-input-group">
          <label for="valeurFossile">Fossile :</label>
          <input type="number" id="valeurFossile" class="banner-input" value="7" min="0" step="0.1">
          <span class="banner-unit">%</span>
        </div>
        <div class="banner-input-group">
          <label for="valeurHydraulique">Hydraulique :</label>
          <input type="number" id="valeurHydraulique" class="banner-input" value="4.5" min="0" step="0.1">
          <span class="banner-unit">%</span>
        </div>
        <div class="banner-input-group">
          <label for="valeurEolienne">√âolienne :</label>
          <input type="number" id="valeurEolienne" class="banner-input" value="3" min="0" step="0.1">
          <span class="banner-unit">%</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">‚öôÔ∏è Param√®tres Globaux</div>
    
    <div class="dropdown-container">
      <select class="dropdown" id="energieGlobale">
        <option value="">S√©lectionner l'√©nergie utilis√©e</option>
        <option value="Fossile">Fossile</option>
        <option value="Hydraulique">Hydraulique</option>
        <option value="√âolienne">√âolienne</option>
      </select>
    </div>
    
    <div class="dropdown-container">
      <select class="dropdown" id="objectifGlobal">
        <option value="">S√©lectionner l'objectif (%)</option>
        <option value="80">80%</option>
        <option value="85">85%</option>
        <option value="90">90%</option>
        <option value="95">95%</option>
        <option value="97">97%</option>
        <option value="100">100%</option>
      </select>
    </div>
    
    <div class="param-grid">
      <div class="param-item">
        <span class="param-label">Cellules Fossiles requises</span>
        <div class="param-value" id="totalFossile">0</div>
      </div>
      <div class="param-item">
        <span class="param-label">Cellules Hydrauliques requises</span>
        <div class="param-value" id="totalHydraulique">0</div>
      </div>
      <div class="param-item">
        <span class="param-label">Cellules √âoliennes requises</span>
        <div class="param-value" id="totalEolienne">0</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-header" onclick="toggleSection('civile')">
      <span>üèòÔ∏è TOURN√âE CIVILE</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div class="section-content" id="civile-content">
      <div id="civile-zones"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header" onclick="toggleSection('entreprise')">
      <span>üè¢ TOURN√âE ENTREPRISE</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div class="section-content" id="entreprise-content">
      <div id="entreprise-zones"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header" onclick="toggleSection('recharge')">
      <span>‚ö° TOURN√âE RECHARGE</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div class="section-content" id="recharge-content">
      <div id="recharge-zones"></div>
    </div>
  </div>

  <div class="card">
    <div class="actions">
      <button class="btn btn-secondary" onclick="effacerTout()">üóëÔ∏è Effacer</button>
      <button class="btn btn-primary" onclick="validerCalcul()">‚úì Valider</button>
    </div>
  </div>

  <div class="card">
    <div class="card-title">üîß Gestion des Bornes</div>
    
    <div class="gestion-section">
      <h3 class="gestion-subtitle">‚ûï Ajouter une borne</h3>
      <div class="gestion-form">
        <div class="form-group">
          <label for="ajoutTournee">Tourn√©e :</label>
          <select id="ajoutTournee" class="form-select">
            <option value="">S√©lectionner...</option>
            <option value="civile">Civile</option>
            <option value="entreprise">Entreprise</option>
            <option value="recharge">Recharge</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="ajoutZone">Zone :</label>
          <select id="ajoutZone" class="form-select">
            <option value="">S√©lectionner...</option>
            <option value="nord">Nord</option>
            <option value="est">Est</option>
            <option value="ouest">Ouest</option>
            <option value="sud">Sud</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="ajoutNom">Nom de la borne :</label>
          <input type="text" id="ajoutNom" class="form-input" placeholder="Ex: Nouvelle borne">
        </div>
        
        <button class="btn btn-add" onclick="ajouterBorne()">‚ûï Ajouter</button>
      </div>
    </div>
    
    <hr class="separator">
    
    <div class="gestion-section">
      <h3 class="gestion-subtitle">üóëÔ∏è Supprimer une borne</h3>
      <div class="gestion-form">
        <div class="form-group">
          <label for="suppTournee">Tourn√©e :</label>
          <select id="suppTournee" class="form-select" onchange="chargerBornesSupp()">
            <option value="">S√©lectionner...</option>
            <option value="civile">Civile</option>
            <option value="entreprise">Entreprise</option>
            <option value="recharge">Recharge</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="suppZone">Zone :</label>
          <select id="suppZone" class="form-select" onchange="chargerBornesSupp()">
            <option value="">S√©lectionner...</option>
            <option value="nord">Nord</option>
            <option value="est">Est</option>
            <option value="ouest">Ouest</option>
            <option value="sud">Sud</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="suppBorne">Borne :</label>
          <select id="suppBorne" class="form-select">
            <option value="">S√©lectionner d'abord tourn√©e et zone</option>
          </select>
        </div>
        
        <button class="btn btn-delete" onclick="supprimerBorne()">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
'use strict';

const firebaseConfig = {
  apiKey: "AIzaSyDi77KPUfS31qGVC9OWM9Bo5sFEwl3RX34",
  authDomain: "calculatrys.firebaseapp.com",
  databaseURL: "https://calculatrys-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "calculatrys",
  storageBucket: "calculatrys.firebasestorage.app",
  messagingSenderId: "77257879994",
  appId: "1:77257879994:web:754ec6eb724bf10ffd6d83"
};

let database;
let firebaseInitialized = false;

try {
  firebase.initializeApp(firebaseConfig);
  database = firebase.database();
  firebaseInitialized = true;
  console.log('‚úÖ Firebase initialis√©');
} catch (error) {
  console.error('‚ùå Erreur Firebase:', error);
}

const bornesDataDefault = {
  civile: {
    nord: ['Base Militaire', 'Culs nus', 'Paleto', 'Nord', 'Grapeseed'],
    est: ['Sandy Nord', 'Prison', 'NOOSE', 'Zone Indu', 'LSMC Civile'],
    ouest: ['Ferme', 'Vinewood', 'Golf', 'Kortz'],
    sud: ['Centrale', 'Rockford Plaza', 'Grande roue', 'MHC', 'A√©roport']
  },
  entreprise: {
    nord: ['Ch√¢teau Marius', 'PAWL', 'MTP', 'LSCS', 'BCSO', 'LSMC Nord', 'Yellow Jack', 'New Gahray Nord'],
    sud: ['STONK', 'MDR', 'Carl Jr', 'LSPD', 'DeMetal', 'LSMC', 'Bahama Unicorn', 'New Gahray Sud', 'BlueBird', 'Twitch News', 'Bahama Mamas', 'You News']
  },
  recharge: {
    nord: ['Paleto R', 'Zancudo', 'Grapeseed', 'Sandy Shores', 'Route 68', 'UPW', 'Palomino', 'Tongva Valley'],
    sud: ['Clinton', 'Mirror Park', 'Popular', 'LSMC R', 'La Puerta', 'Auto-√©cole', 'Little Seoul', 'Del Perro', 'GOH']
  }
};

let bornesData = JSON.parse(JSON.stringify(bornesDataDefault));

function chargerDonneesFirebase() {
  if (!firebaseInitialized) {
    console.warn('‚ö†Ô∏è Firebase non initialis√©');
    createBornesList();
    return;
  }

  // √âcoute en temps r√©el des changements de bornesData
  database.ref('bornesData').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      bornesData = data;
      console.log('üîÑ Donn√©es synchronis√©es');
      recreerInterface();
    } else {
      sauvegarderBornesData();
      createBornesList();
    }
  }, (error) => {
    console.error('‚ùå Erreur √©coute:', error);
    createBornesList();
  });

  // √âcoute en temps r√©el des changements de valeurs de cellules
  database.ref('valeursCellules').on('value', (snapshot) => {
    const valeurs = snapshot.val();
    if (valeurs) {
      document.getElementById('valeurFossile').value = valeurs.fossile || 7;
      document.getElementById('valeurHydraulique').value = valeurs.hydraulique || 4.5;
      document.getElementById('valeurEolienne').value = valeurs.eolienne || 3;
      updateBannerPreview();
      calculerCellules();
      console.log('üîÑ Valeurs synchronis√©es');
    }
  }, (error) => {
    console.error('‚ùå Erreur √©coute valeurs:', error);
  });

  // √âcoute en temps r√©el des √©tats des bornes (cases coch√©es, valeurs, etc.)
  database.ref('etatsbornes').on('value', (snapshot) => {
    const etats = snapshot.val();
    if (etats && !window.isUpdatingFromFirebase) {
      console.log('üîÑ √âtats des bornes synchronis√©s');
      window.isUpdatingFromFirebase = true;
      appliquerEtatsBornes(etats);
      window.isUpdatingFromFirebase = false;
    }
  }, (error) => {
    console.error('‚ùå Erreur √©coute √©tats:', error);
  });
}

function sauvegarderBornesData() {
  if (!firebaseInitialized) return;
  database.ref('bornesData').set(bornesData)
    .then(() => console.log('‚úÖ Bornes sauvegard√©es'))
    .catch((error) => console.error('‚ùå Erreur:', error));
}

function sauvegarderValeursCellules() {
  if (!firebaseInitialized) return;
  const valeurs = {
    fossile: parseFloat(document.getElementById('valeurFossile').value) || 7,
    hydraulique: parseFloat(document.getElementById('valeurHydraulique').value) || 4.5,
    eolienne: parseFloat(document.getElementById('valeurEolienne').value) || 3
  };
  database.ref('valeursCellules').set(valeurs)
    .then(() => console.log('‚úÖ Valeurs sauvegard√©es'))
    .catch((error) => console.error('‚ùå Erreur:', error));
}

function sauvegarderEtatsBornes() {
  if (!firebaseInitialized || window.isUpdatingFromFirebase) return;
  
  const etats = {};
  document.querySelectorAll('.borne-item').forEach(item => {
    const checkbox = item.querySelector('.borne-checkbox');
    const id = checkbox.id;
    
    etats[id] = {
      checked: checkbox.checked,
      energie: item.querySelector('.borne-energie').value,
      pourcentage: item.querySelector('.borne-input').value,
      objectif: item.querySelector('.borne-objectif').value
    };
  });
  
  database.ref('etatsbornes').set(etats)
    .then(() => console.log('‚úÖ √âtats sauvegard√©s'))
    .catch((error) => console.error('‚ùå Erreur:', error));
}

function appliquerEtatsBornes(etats) {
  Object.keys(etats).forEach(id => {
    const item = document.getElementById(id);
    if (item) {
      const etat = etats[id];
      const borneItem = item.closest('.borne-item');
      
      item.checked = etat.checked || false;
      borneItem.querySelector('.borne-energie').value = etat.energie || '';
      borneItem.querySelector('.borne-input').value = etat.pourcentage || '0';
      borneItem.querySelector('.borne-objectif').value = etat.objectif || '';
    }
  });
  calculerCellules();
}

const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark-mode');
  themeToggle.checked = true;
}
themeToggle.addEventListener('change', () => {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('theme', themeToggle.checked ? 'dark' : 'light');
});

function toggleSection(id) {
  const content = document.getElementById(id + '-content');
  const header = content.previousElementSibling;
  content.classList.toggle('active');
  header.classList.toggle('active');
}

function toggleZone(zoneDiv) {
  const header = zoneDiv.querySelector('.zone-header');
  const content = zoneDiv.querySelector('.zone-content');
  content.classList.toggle('active');
  header.classList.toggle('active');
}

function toggleBanner() {
  const content = document.getElementById('bannerContent');
  const arrow = document.getElementById('bannerArrow');
  content.classList.toggle('active');
  arrow.classList.toggle('active');
}

function updateBannerPreview() {
  const fossile = document.getElementById('valeurFossile').value;
  const hydraulique = document.getElementById('valeurHydraulique').value;
  const eolienne = document.getElementById('valeurEolienne').value;
  document.getElementById('bannerValuesPreview').innerHTML = `
    <span>Fossile : <strong>${fossile}</strong> %</span>
    <span>Hydraulique : <strong>${hydraulique}</strong> %</span>
    <span>√âolienne : <strong>${eolienne}</strong> %</span>
  `;
}

function createBornesList() {
  Object.keys(bornesData).forEach(tournee => {
    const container = document.getElementById(tournee + '-zones');
    Object.keys(bornesData[tournee]).forEach(zone => {
      const zoneDiv = document.createElement('div');
      zoneDiv.style.marginBottom = '15px';
      
      const zoneHeader = document.createElement('div');
      zoneHeader.className = 'zone-header';
      zoneHeader.innerHTML = `
        <span>üìç Zone ${zone.charAt(0).toUpperCase() + zone.slice(1)}</span>
        <span class="arrow">‚ñº</span>
      `;
      zoneHeader.onclick = () => toggleZone(zoneDiv);
      zoneDiv.appendChild(zoneHeader);
      
      const zoneContent = document.createElement('div');
      zoneContent.className = 'zone-content';
      
      const borneList = document.createElement('div');
      borneList.className = 'borne-list';
      
      bornesData[tournee][zone].forEach((borne, index) => {
        const borneItem = document.createElement('div');
        borneItem.className = 'borne-item';
        borneItem.innerHTML = `
          <input type="checkbox" class="borne-checkbox" id="${tournee}-${zone}-${index}">
          <span class="borne-name">${borne}</span>
          <select class="borne-energie">
            <option value="">Global</option>
            <option value="Fossile">Fossile</option>
            <option value="Hydraulique">Hydraulique</option>
            <option value="√âolienne">√âolienne</option>
          </select>
          <input type="number" class="borne-input" placeholder="%" min="0" max="100" value="0">
          <select class="borne-objectif">
            <option value="">Global</option>
            <option value="80">80%</option>
            <option value="85">85%</option>
            <option value="90">90%</option>
            <option value="95">95%</option>
            <option value="97">97%</option>
            <option value="100">100%</option>
          </select>
          <span class="borne-result">0 cellules</span>
          <span class="borne-capacity">0%</span>
        `;
        borneList.appendChild(borneItem);
      });
      
      zoneContent.appendChild(borneList);
      zoneDiv.appendChild(zoneContent);
      container.appendChild(zoneDiv);
    });
  });
}

function calculerCellules() {
  const energieGlobale = document.getElementById('energieGlobale').value;
  const objectifGlobal = parseInt(document.getElementById('objectifGlobal').value) || 100;
  const valeurFossile = parseFloat(document.getElementById('valeurFossile').value) || 7;
  const valeurHydraulique = parseFloat(document.getElementById('valeurHydraulique').value) || 4.5;
  const valeurEolienne = parseFloat(document.getElementById('valeurEolienne').value) || 3;
  
  let totalFossile = 0, totalHydraulique = 0, totalEolienne = 0;
  
  document.querySelectorAll('.borne-item').forEach(item => {
    const checkbox = item.querySelector('.borne-checkbox');
    const energieSelect = item.querySelector('.borne-energie');
    const input = item.querySelector('.borne-input');
    const objectifSelect = item.querySelector('.borne-objectif');
    const result = item.querySelector('.borne-result');
    const capacity = item.querySelector('.borne-capacity');
    
    if (checkbox.checked) {
      const energie = energieSelect.value || energieGlobale;
      const objectif = parseInt(objectifSelect.value) || objectifGlobal;
      const energieActuelle = parseFloat(input.value) || 0;
      const diff = objectif - energieActuelle;
      
      let valeurCellule = 0;
      if (energie === 'Fossile') valeurCellule = valeurFossile;
      else if (energie === 'Hydraulique') valeurCellule = valeurHydraulique;
      else if (energie === '√âolienne') valeurCellule = valeurEolienne;
      
      let cellules = 0;
      let capaciteFinale = energieActuelle;
      
      if (diff > 0 && valeurCellule > 0) {
        cellules = Math.floor(diff / valeurCellule);
        let capaciteAvecCellules = energieActuelle + (cellules * valeurCellule);
        if (capaciteAvecCellules < objectif && (capaciteAvecCellules + valeurCellule) <= 100) {
          cellules++;
        }
        capaciteFinale = Math.min(100, energieActuelle + (cellules * valeurCellule));
      }
      
      if (energie === 'Fossile') totalFossile += cellules;
      else if (energie === 'Hydraulique') totalHydraulique += cellules;
      else if (energie === '√âolienne') totalEolienne += cellules;
      
      result.textContent = `${cellules} cellules`;
      capacity.textContent = `${capaciteFinale.toFixed(1)}%`;
      
      capacity.className = 'borne-capacity';
      if (capaciteFinale >= objectif) {
      } else if (capaciteFinale >= objectif - valeurCellule) {
        capacity.classList.add('warning');
      } else {
        capacity.classList.add('error');
      }
    } else {
      result.textContent = '0 cellules';
      capacity.textContent = input.value ? `${parseFloat(input.value).toFixed(1)}%` : '0%';
      capacity.className = 'borne-capacity';
    }
  });
  
  document.getElementById('totalFossile').textContent = totalFossile;
  document.getElementById('totalHydraulique').textContent = totalHydraulique;
  document.getElementById('totalEolienne').textContent = totalEolienne;
}

function effacerTout() {
  document.querySelectorAll('.borne-checkbox').forEach(cb => cb.checked = false);
  document.querySelectorAll('.borne-input').forEach(input => input.value = 0);
  calculerCellules();
  sauvegarderEtatsBornes();
}

function validerCalcul() {
  calculerCellules();
  sauvegarderEtatsBornes();
  alert('Calcul valid√© ! V√©rifiez les totaux dans les param√®tres globaux.');
}

function ajouterBorne() {
  const tournee = document.getElementById('ajoutTournee').value;
  const zone = document.getElementById('ajoutZone').value;
  const nom = document.getElementById('ajoutNom').value.trim();
  
  if (!tournee || !zone || !nom) {
    alert('‚ö†Ô∏è Veuillez remplir tous les champs !');
    return;
  }
  
  if (!bornesData[tournee] || !bornesData[tournee][zone]) {
    alert('‚ö†Ô∏è Cette combinaison tourn√©e/zone n\'existe pas !');
    return;
  }
  
  if (bornesData[tournee][zone].includes(nom)) {
    alert('‚ö†Ô∏è Une borne avec ce nom existe d√©j√† dans cette zone !');
    return;
  }
  
  bornesData[tournee][zone].push(nom);
  sauvegarderBornesData();
  recreerInterface();
  
  document.getElementById('ajoutTournee').value = '';
  document.getElementById('ajoutZone').value = '';
  document.getElementById('ajoutNom').value = '';
  
  alert(`‚úÖ La borne "${nom}" a √©t√© ajout√©e avec succ√®s !`);
}

function chargerBornesSupp() {
  const tournee = document.getElementById('suppTournee').value;
  const zone = document.getElementById('suppZone').value;
  const selectBorne = document.getElementById('suppBorne');
  
  selectBorne.innerHTML = '<option value="">S√©lectionner une borne</option>';
  
  if (tournee && zone && bornesData[tournee] && bornesData[tournee][zone]) {
    bornesData[tournee][zone].forEach((borne, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = borne;
      selectBorne.appendChild(option);
    });
  }
}

function supprimerBorne() {
  const tournee = document.getElementById('suppTournee').value;
  const zone = document.getElementById('suppZone').value;
  const borneIndex = document.getElementById('suppBorne').value;
  
  if (!tournee || !zone || borneIndex === '') {
    alert('‚ö†Ô∏è Veuillez s√©lectionner une tourn√©e, une zone et une borne !');
    return;
  }
  
  const nomBorne = bornesData[tournee][zone][borneIndex];
  
  if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la borne "${nomBorne}" ?`)) {
    return;
  }
  
  bornesData[tournee][zone].splice(borneIndex, 1);
  sauvegarderBornesData();
  recreerInterface();
  
  document.getElementById('suppTournee').value = '';
  document.getElementById('suppZone').value = '';
  document.getElementById('suppBorne').innerHTML = '<option value="">S√©lectionner d\'abord tourn√©e et zone</option>';
  
  alert(`‚úÖ La borne "${nomBorne}" a √©t√© supprim√©e avec succ√®s !`);
}

function recreerInterface() {
  // √âvite de recr√©er l'interface si elle est d√©j√† en cours de cr√©ation
  if (window.isRecreatingInterface) return;
  window.isRecreatingInterface = true;
  
  document.getElementById('civile-zones').innerHTML = '';
  document.getElementById('entreprise-zones').innerHTML = '';
  document.getElementById('recharge-zones').innerHTML = '';
  createBornesList();
  calculerCellules();
  
  window.isRecreatingInterface = false;
}

document.getElementById('energieGlobale').addEventListener('change', calculerCellules);
document.getElementById('objectifGlobal').addEventListener('change', calculerCellules);

document.getElementById('valeurFossile').addEventListener('input', () => {
  updateBannerPreview();
  calculerCellules();
  sauvegarderValeursCellules();
});
document.getElementById('valeurHydraulique').addEventListener('input', () => {
  updateBannerPreview();
  calculerCellules();
  sauvegarderValeursCellules();
});
document.getElementById('valeurEolienne').addEventListener('input', () => {
  updateBannerPreview();
  calculerCellules();
  sauvegarderValeursCellules();
});

document.addEventListener('change', (e) => {
  if (e.target.classList.contains('borne-checkbox') || 
      e.target.classList.contains('borne-input') ||
      e.target.classList.contains('borne-energie') ||
      e.target.classList.contains('borne-objectif')) {
    calculerCellules();
    sauvegarderEtatsBornes();
  }
});

// Sauvegarde aussi lors de la saisie dans les inputs (en temps r√©el)
document.addEventListener('input', (e) => {
  if (e.target.classList.contains('borne-input')) {
    calculerCellules();
    // Utilise un d√©lai pour √©viter trop de sauvegardes
    clearTimeout(window.saveTimeout);
    window.saveTimeout = setTimeout(() => {
      sauvegarderEtatsBornes();
    }, 500);
  }
});

window.addEventListener('load', () => {
  chargerDonneesFirebase();
});
</script>

</body>
</html>